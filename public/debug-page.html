<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIP GUS Plugin Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }

        .debug-container {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="debug-container">
        <h2>üéØ NIP GUS Plugin - Debug Page</h2>
        <div class="status">
            ‚úÖ HTML strona zosta≈Ça za≈Çadowana przez Pipedrive
        </div>

        <div id="js-status" class="error">
            ‚ùå JavaScript jeszcze siƒô nie za≈Çadowa≈Ç
        </div>

        <div id="pipedrive-status" class="error">
            ‚ùå Pipedrive SDK nie zosta≈Ç wykryty
        </div>

        <div id="url-info">
            <strong>URL:</strong> <span id="current-url">≈Åadowanie...</span>
        </div>

        <div id="session-info">
            <strong>Session:</strong> <span id="session-status">Sprawdzanie...</span>
        </div>

        <button onclick="testOAuth()"
            style="margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Test OAuth
        </button>
    </div>

    <script>
        console.log('üî• DEBUG PAGE: JavaScript loading...');

        // Aktualizuj status JS
        document.getElementById('js-status').innerHTML = '‚úÖ JavaScript zosta≈Ç za≈Çadowany';
        document.getElementById('js-status').className = 'status';

        // Poka≈º URL
        document.getElementById('current-url').textContent = window.location.href;

        // Sprawd≈∫ Pipedrive SDK
        if (window.Pipedrive) {
            document.getElementById('pipedrive-status').innerHTML = '‚úÖ Pipedrive SDK wykryty';
            document.getElementById('pipedrive-status').className = 'status';
            console.log('‚úÖ Pipedrive SDK available:', window.Pipedrive);
        } else {
            console.log('‚ùå Pipedrive SDK not available');
        }

        // Sprawd≈∫ session
        const sessionId = localStorage.getItem('nip_gus_session_id');
        const urlParams = new URLSearchParams(window.location.search);
        const sessionFromUrl = urlParams.get('nip_gus_session');

        let sessionStatus = 'Brak sesji';
        if (sessionFromUrl) {
            sessionStatus = `URL: ${sessionFromUrl.substring(0, 20)}...`;
            localStorage.setItem('nip_gus_session_id', sessionFromUrl);
        } else if (sessionId) {
            sessionStatus = `LocalStorage: ${sessionId.substring(0, 20)}...`;
        }

        document.getElementById('session-status').textContent = sessionStatus;

        // Test OAuth function
        function testOAuth() {
            console.log('üîê Testing OAuth...');
            alert('Test OAuth clicked! Check console for details.');

            // Sprawd≈∫ domenƒô
            const hostname = window.location.hostname;
            const match = hostname.match(/^(.+)\.pipedrive\.com$/);
            const companyDomain = match ? match[1] : null;

            console.log('Company domain:', companyDomain);

            if (companyDomain) {
                const authUrl = `https://pipedrive-oauth-server.devikit.pl/auth/authorize?company_domain=${companyDomain}&return_url=${encodeURIComponent(window.location.href)}`;
                console.log('Auth URL:', authUrl);

                if (confirm('Przekierowaƒá do OAuth?')) {
                    window.location.href = authUrl;
                }
            } else {
                alert('Nie mo≈ºna okre≈õliƒá domeny firmy');
            }
        }

        // Dodaj do globalnego scope dla debugowania
        window.testOAuth = testOAuth;

        console.log('üéâ DEBUG PAGE: Initialization complete');
    </script>
</body>

</html>